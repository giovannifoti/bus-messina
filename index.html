<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Messina</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f9;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      width: 250px;
      height: 100vh;
      background: #fff;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      padding: 10px;
      overflow-y: auto;
      z-index: 1000;
    }
    #sidebar h2 {
      margin-top: 0;
      font-size: 18px;
    }
    #fav-list {
      list-style: none;
      padding: 0;
    }
    #fav-list li {
      margin-bottom: 5px;
      cursor: pointer;
      color: #007bff;
    }
    #map {
      position: absolute;
      top: 0;
      left: 250px;
      right: 0;
      bottom: 0;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1001;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .top-bar button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .closest-stop a {
      font-weight: bold;
      color: #e91e63;
      text-decoration: none;
    }
    .distance-info {
      font-size: 14px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Fermate Preferite</h2>
    <ul id="fav-list"></ul>
  </div>
  <div class="top-bar">
    <button id="locBtn">üìç Attiva localizzazione</button>
    <div id="closest-stop" class="closest-stop"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Lettura preferiti da localStorage
    let favStops = JSON.parse(localStorage.getItem('favStops')) || [];

    const map = L.map('map').setView([38.1938, 15.5540], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
    }).addTo(map);

    const defaultIcon = new L.Icon.Default();
    const starIcon = L.divIcon({
      html: '<span style="font-size:24px; color: gold;">‚òÖ</span>',
      iconSize: [24, 24],
      className: ''
    });

    const markerMap = {};
    const stopDataUrl = 'stops_fixed.json';

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) ** 2 +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function formatDistance(meters) {
      return meters >= 1000 ? (meters / 1000).toFixed(2) + ' km' : Math.round(meters) + ' m';
    }

    // Carica le fermate, crea i marker e applica le preferenze salvate
    fetch(stopDataUrl)
      .then(response => response.json())
      .then(stops => {
        stops.forEach(stop => {
          const isFav = favStops.includes(stop.name);
          const marker = L.marker([stop.lat, stop.lon], { icon: isFav ? starIcon : defaultIcon }).addTo(map);
          markerMap[stop.name] = marker;
          const popupContent = `
            <strong>${stop.name}</strong><br>
            <a href="${stop.url}" target="_blank">Vedi fermata</a><br>
            <button class="fav-btn" data-stop-name="${stop.name}">‚òÜ Aggiungi ai preferiti</button>
            <div class="distance-info" id="dist-${stop.name.replace(/\s+/g, '_')}"></div>
          `;
          marker.bindPopup(popupContent);
        });
        updateSidebar();
      });

    // Aggiorna la sidebar dei preferiti
    function updateSidebar() {
      const list = document.getElementById('fav-list');
      list.innerHTML = '';
      favStops.forEach(name => {
        const li = document.createElement('li');
        li.innerText = name;
        li.addEventListener('click', () => {
          const marker = markerMap[name];
          if (marker) {
            map.setView(marker.getLatLng(), 16);
            marker.openPopup();
          }
        });
        list.appendChild(li);
      });
      localStorage.setItem('favStops', JSON.stringify(favStops));
    }

    // Gestione del click sui bottoni 'fav-btn' nei popup
    map.on('popupopen', e => {
      const btn = e.popup._contentNode.querySelector('.fav-btn');
      const stopName = btn.getAttribute('data-stop-name');
      btn.innerText = favStops.includes(stopName) ? '‚òÖ Rimuovi preferito' : '‚òÜ Aggiungi ai preferiti';
      btn.addEventListener('click', () => {
        if (favStops.includes(stopName)) {
          favStops = favStops.filter(n => n !== stopName);
          markerMap[stopName].setIcon(defaultIcon);
        } else {
          favStops.push(stopName);
          markerMap[stopName].setIcon(starIcon);
        }
        updateSidebar();
        btn.innerText = favStops.includes(stopName) ? '‚òÖ Rimuovi preferito' : '‚òÜ Aggiungi ai preferiti';
      });
    });

    // Toggle localizzazione
    let userMarker = null;
    const locBtn = document.getElementById('locBtn');
    locBtn.addEventListener('click', () => {
      if (!userMarker) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(position => {
            const latlng = [position.coords.latitude, position.coords.longitude];
            userMarker = L.circleMarker(latlng, {
              radius: 8, fillColor: '#007bff', color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
            }).addTo(map).bindPopup("Tu sei qui").openPopup();
            map.setView(latlng, 14);
            locBtn.innerText = 'üìç Localizzazione attivata';

            // Calcola distanze e fermata pi√π vicina
            fetch(stopDataUrl)
              .then(response => response.json())
              .then(stops => {
                let closestStop = null;
                let minDistance = Infinity;
                stops.forEach(stop => {
                  const dist = calculateDistance(latlng[0], latlng[1], stop.lat, stop.lon);
                  const el = document.getElementById("dist-" + stop.name.replace(/\s+/g, '_'));
                  if (el) el.innerText = "Distanza: " + formatDistance(dist);
                  if (dist < minDistance) {
                    minDistance = dist;
                    closestStop = stop;
                  }
                });
                if (closestStop) {
                  document.getElementById('closest-stop').innerHTML =
                    `<a href="\${closestStop.url}" target="_blank">
                      üöè Fermata pi√π vicina: \${closestStop.name} (\${formatDistance(minDistance)})
                    </a>`;
                }
              });
          });
        } else {
          alert("La geolocalizzazione non √® supportata dal tuo browser.");
        }
      } else {
        map.removeLayer(userMarker);
        userMarker = null;
        locBtn.innerText = 'üìç Attiva localizzazione';
        document.getElementById('closest-stop').innerHTML = '';
        document.querySelectorAll('.distance-info').forEach(el => el.innerText = '');
      }
    });
  </script>
</body>
</html>
