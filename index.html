<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Messina</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f4f9;
    }
    #map {
      height: 100vh;
      width: 100%;
    }
    .top-bar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px 20px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .top-bar button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .distance-info {
      font-size: 14px;
      margin-top: 4px;
    }
    .closest-stop {
      font-weight: bold;
      margin-top: 8px;
      color: #e91e63;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <!-- Added id for button to allow text change -->
    <button id="locBtn" onclick="getLocation()">üìç Attiva localizzazione</button>
    <span id="closest-stop" class="closest-stop"></span>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([38.1938, 15.5540], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
    }).addTo(map);

    let userLatLng = null;
    const stopDataUrl = 'stops_fixed.json'; // Deve essere nel repo

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function formatDistance(meters) {
      return meters >= 1000 ? (meters / 1000).toFixed(2) + ' km' : Math.round(meters) + ' m';
    }

    fetch(stopDataUrl)
      .then(response => response.json())
      .then(stops => {
        stops.forEach(stop => {
          const marker = L.marker([stop.lat, stop.lon]).addTo(map);
          // Fix: usa stop.url invece di stop.link
          marker.bindPopup(
            `<strong>${stop.name}</strong><br>` +
            `<a href="${stop.url}" target="_blank">Vedi fermata</a>` +
            `<div class="distance-info" id="dist-${stop.name.replace(/\s+/g, '_')}"></div>`
          );
        });
      });

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } else {
        alert("La geolocalizzazione non √® supportata dal tuo browser.");
      }
    }

    function showPosition(position) {
      userLatLng = [position.coords.latitude, position.coords.longitude];
      const userMarker = L.circleMarker(userLatLng, {
        radius: 8, fillColor: '#007bff', color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
      }).addTo(map).bindPopup("Tu sei qui").openPopup();
      map.setView(userLatLng, 14);

      // Cambia testo del pulsante una volta attivata la geolocalizzazione
      const btn = document.getElementById('locBtn');
      btn.innerText = 'üìç Localizzazione attiva';
      btn.disabled = true; // opzionale, disabilita per evitare ulteriori click

      fetch(stopDataUrl)
        .then(response => response.json())
        .then(stops => {
          let closestStop = null;
          let minDistance = Infinity;

          stops.forEach(stop => {
            const dist = calculateDistance(userLatLng[0], userLatLng[1], stop.lat, stop.lon);
            if (dist < minDistance) {
              minDistance = dist;
              closestStop = stop;
            }
            const el = document.getElementById("dist-" + stop.name.replace(/\s+/g, '_'));
            if (el) el.innerText = "Distanza: " + formatDistance(dist);
          });

          if (closestStop) {
            document.getElementById('closest-stop').innerText =
              `üöè Fermata pi√π vicina: ${closestStop.name} (${formatDistance(minDistance)})`;
          }
        });
    }
  </script>
</body>
</html>
